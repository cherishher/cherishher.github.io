<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="HH的博客">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        Pig &amp; Hive使用整理总结 - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> keep hungry, then you&#39;ll be really hungry </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>Max Qi</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pig-amp-amp-Hive-简介"><span class="toc-text">Pig &amp;&amp; Hive 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pig"><span class="toc-text">Pig</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pig-好处："><span class="toc-text">Pig 好处：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#语言特性："><span class="toc-text">语言特性：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pig-简单架构如图："><span class="toc-text">Pig 简单架构如图：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tez"><span class="toc-text">Tez</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Tez执行步骤："><span class="toc-text">Tez执行步骤：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hive"><span class="toc-text">Hive</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hive安装与启动"><span class="toc-text">Hive安装与启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hive数据模型"><span class="toc-text">Hive数据模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HiveQL命令"><span class="toc-text">HiveQL命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Create"><span class="toc-text">Create:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Load"><span class="toc-text">Load:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hive整体架构"><span class="toc-text">Hive整体架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Problem"><span class="toc-text">Problem</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> keep hungry, then you&#39;ll be really hungry </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Pig & Hive使用整理总结
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2019-02-13 14:52:26</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#big data" title="big data">big data</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h2 id="Pig-amp-amp-Hive-简介"><a href="#Pig-amp-amp-Hive-简介" class="headerlink" title="Pig &amp;&amp; Hive 简介"></a>Pig &amp;&amp; Hive 简介</h2><p>pig和hive简单来说是使用类sql的语言来做mapreduce jobs数据查询与处理的框架。对于比较复杂的MR程序，可以直接使用缝钻噶后的Pig Latin或者HQL来做，由框架将其转化为hadoop jobs。pig属于大规模数据处理系统，而hive则属于hadoop的一个数据仓库应用。</p>
<h2 id="Pig"><a href="#Pig" class="headerlink" title="Pig"></a>Pig</h2><p>虽然被淘汰了，但还是要简单了解一下pig，毕竟是曾经风靡一时的框架。先简单看一下pig的代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">users = <span class="keyword">load</span> <span class="string">'users.csv'</span> <span class="keyword">as</span> (username: chararray, age: <span class="built_in">int</span>);</span><br><span class="line">users_1825 = filter users by age&gt;=18 and age&lt;=25; -- 这里的filter和上面的load可以在一个map里完成，减少shuffle内容</span><br><span class="line"></span><br><span class="line">pages = <span class="keyword">load</span> <span class="string">'pages.csv'</span> <span class="keyword">as</span> (username: chararray, <span class="keyword">url</span>: chararray);</span><br><span class="line"></span><br><span class="line">joined = join users_1825 by username, pages by username;</span><br><span class="line">grouped = group joined by url;</span><br><span class="line">summed = foreach grouped generate group as url, COUNT(joined) as views;</span><br><span class="line">sorted = order summed by views desc;</span><br><span class="line">top_5 = limit sorted 5;</span><br><span class="line"></span><br><span class="line">store top_5 into 'top_5_sites.csv';</span><br></pre></td></tr></table></figure>
<h3 id="Pig-好处："><a href="#Pig-好处：" class="headerlink" title="Pig 好处："></a>Pig 好处：</h3><p>使用pig latin的好处有：</p>
<ol>
<li>pig latin懒加载，可以在pipeline中存储任意节点，而sql无法存储中间结果（可以说pig latin是将sql分拆成单个子语句）。</li>
<li>使用pig latin而不是直接写hadoop jobs可以极大的减少代码量，减轻程序员负担。</li>
<li>pig latin的运行效率不会太慢，同一个job所用时间不超过原生MR jobs的两倍。</li>
</ol>
<h3 id="语言特性："><a href="#语言特性：" class="headerlink" title="语言特性："></a>语言特性：</h3><ul>
<li>Keywords：Load, Filter, Foreach, Group By等，与sql相似</li>
<li>Aggregations：Count, Avg, Sum,Max等，这些操作一般来说会shuffle job</li>
<li>Schema：在load数据的时候就需要声明schema</li>
<li>User Defined Functions(UDFs)：用户定义的函数，需要先定义在jar包里，然后在pig latin里用register注册对应jar包从而进行调用</li>
</ul>
<h3 id="Pig-简单架构如图："><a href="#Pig-简单架构如图：" class="headerlink" title="Pig 简单架构如图："></a>Pig 简单架构如图：</h3><p><img src="/img/pigArc.png" alt="pigArc"></p>
<p>注意：基于效率原因，pig后面使用Tez取代直接做mapreduce jobs。</p>
<h2 id="Tez"><a href="#Tez" class="headerlink" title="Tez"></a>Tez</h2><p>Hadoop2.x对hadoop的架构进行了大规模的改动，其中比较重要的是：</p>
<ul>
<li>使用Yarn进行资源管理</li>
<li>将Tez作为Pig和hive的执行引擎（而不是直接用mapreduce）</li>
<li>提供了各种各样的用户api，支持更多应用</li>
</ul>
<p><img src="/img/hadoop2.x arc.png" alt="hadoop2.x arc"></p>
<h3 id="Tez执行步骤："><a href="#Tez执行步骤：" class="headerlink" title="Tez执行步骤："></a>Tez执行步骤：</h3><p>Tez是一个基于DAG的框架，具体运行pig步骤为：</p>
<ol>
<li>将pig的数据处理过程表示成一个DAG图</li>
<li>Tez本身可以用来执行基于DAG的计算过程，在此过程中可以优化mapreduce的流程，提高效率。</li>
</ol>
<h2 id="Hive"><a href="#Hive" class="headerlink" title="Hive"></a>Hive</h2><p>hive是一个基于hadoop的数据仓库组件，提供了总结，查询和分析等功能。实际使用时，Hive很像SQL database，HQL的命令也和SQL很像。</p>
<h3 id="Hive安装与启动"><a href="#Hive安装与启动" class="headerlink" title="Hive安装与启动"></a>Hive安装与启动</h3><ol>
<li>从apache官方下载hive</li>
<li>在conf/下新建hive-site.xml，配置mysql，hdfs等相关设置</li>
<li>修改conf/hive-env.sh，配置HADOOP_HOME和HIVE_CONF_DIR</li>
<li>hive直接进入cli，hiveserver2 &amp; 可以开启hive server</li>
</ol>
<h3 id="Hive数据模型"><a href="#Hive数据模型" class="headerlink" title="Hive数据模型"></a>Hive数据模型</h3><p>hive处理的是结构化的数据，有三个层次：</p>
<ul>
<li>Tables（path/warehouse/t）<ul>
<li>每列都有类型（int，string，boolean）</li>
<li>与关系型数据库的table很像</li>
<li>每个表对应了hdfs的一个文件目录</li>
<li>支持list、map，类似json的数据</li>
</ul>
</li>
<li>Partitions (path/warehouse/t/2)<ul>
<li>由数据在表里的分布决定（例如基于范围的partition）</li>
<li>每个partition在表的目录下都有自己的子目录</li>
</ul>
</li>
<li>Buckets (path/warehouse/t/2/part-00000.part)<ul>
<li>partition可以进一步被分成buckets</li>
<li>每个bucket被存在目录下的一个文件里</li>
</ul>
</li>
</ul>
<h3 id="HiveQL命令"><a href="#HiveQL命令" class="headerlink" title="HiveQL命令"></a>HiveQL命令</h3><p>HQL的命令主要有三类</p>
<ul>
<li>Data Definition Language(DDL)：例如create，table，drop table等</li>
<li>Data Manipulation Language(DML)：load和insert命令等</li>
<li>Query Statements：select，join，union等</li>
</ul>
<h4 id="Create"><a href="#Create" class="headerlink" title="Create:"></a>Create:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Create table student(</span><br><span class="line">	id int,</span><br><span class="line">	name string</span><br><span class="line">)</span><br><span class="line">partitioned by (province string)</span><br><span class="line">clustered by (id)</span><br><span class="line">sorted by (id)</span><br><span class="line">into 4 buckets</span><br><span class="line">row format delimited</span><br><span class="line">fields terminated by &apos;\t&apos;</span><br><span class="line">stored as textfile;</span><br></pre></td></tr></table></figure>
<p>在使用create时要声明：</p>
<ol>
<li>schema：（类似RDBMS）</li>
<li>partitions：partitioned by(province string)来确定partitions的名字，其中partition的列名不能是schema中已有的</li>
<li>bucket：则通过clustered/sorted by (id)来实现，其中的列名必须是schema中已有的，还要明确分成几个bucket</li>
<li>format：指原数据的分隔符是什么，如果表声明为’\t’，而text文件用空格分开，则load的数据皆为null</li>
<li>stored：存储形式，推荐用orc</li>
</ol>
<h4 id="Load"><a href="#Load" class="headerlink" title="Load:"></a>Load:</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'path of local file system'</span> overwrite <span class="keyword">into</span> <span class="keyword">table</span> student <span class="keyword">partition</span>(province=<span class="string">'shanxi'</span>) <span class="comment">-- 加载本地text文件</span></span><br><span class="line"><span class="keyword">Load</span> <span class="keyword">data</span> inpath ... <span class="comment">-- 加载hdfs里的文件</span></span><br></pre></td></tr></table></figure>
<p>对于有partition的表，在load数据时一定要声明partition，否则会报错</p>
<h3 id="Hive整体架构"><a href="#Hive整体架构" class="headerlink" title="Hive整体架构"></a>Hive整体架构</h3><p><img src="/img/hive arc.png" alt="hive arc"></p>
<p>注意hive主要的组件包括：</p>
<ul>
<li>Shell：也就是CLI，允许用户像RDBMS一样交互查询</li>
<li>Driver：session的handle、fetch和execute</li>
<li>Compiler：针对hql的parse，plan和optimize</li>
<li>Execution：基于stage的DAG图（mr，hdfs，metadata）</li>
<li>Metastore：包括表定义、表的命名空间和partition信息等，可以存在mysql等关系型数据库里</li>
</ul>
<h3 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h3><p><strong>mysql会报关于ssl访问的warning，但不影响操作？</strong></p>
<p>在hive-site.xml里的mysql配置里声明useSSL=false，如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionURL<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">value</span>&gt;</span>jdbc:mysql://localhost:3306/hive?createDatabaseIfNotExist=true&amp;amp;useSSL=false<span class="tag">&lt;/<span class="name">value</span>&gt;</span> <span class="comment">&lt;!--注意这里的&amp;是用了&amp;amp;否则报错--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>update和delete无法使用，报错信息【Attempt to do update or delete using transaction manager that does not support these operations.】?</strong></p>
<p>要明白hive的文件存储格式主要有：</p>
<ul>
<li>textfile：默认格式，行存储，磁盘开销大，数据解析开销大，hive无法进行合并和拆分，压缩的text文件，load最快</li>
<li>sequencefile：二进制，以&lt;key，value&gt;形式序列化，行存储，可分割压缩，与hadoop api中mapfile兼容，需要通过text来转化load</li>
<li>rcfile：数据按行分块，每块列存储，读尽量涉及最少block，性能不如sequencefile，load最慢</li>
<li>orc：数据按行分块，每块列存储，效率比rcfile高（推荐）</li>
<li>自定义格式</li>
</ul>
<p>这四种，只有orc是支持update和delete操作的，其他都不可以。我之前stored as textfile，自然报错。</p>
<p><strong>hive分bucket的时候mr jobs没动，如何处理？</strong></p>
<p>我使用了tez替代hive-mr来作为hive的执行引擎，网上说这样可以提高3倍效率。</p>
<p><strong>hive on tez如何配置？</strong></p>
<ol>
<li><p>apache官网下载tez</p>
</li>
<li><p>在hadoop/etc/hadoop/下创建tez-site.xml文件，加上配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">	&lt;property&gt;</span><br><span class="line">		&lt;name&gt;tez.lib.uris&lt;/name&gt;</span><br><span class="line">		&lt;value&gt;/user/tez/tez.tar.gz&lt;/value&gt;</span><br><span class="line">	&lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>把位于apache-tez-0.9.0-bin/share下的tez.tar.gz放在hdfs的/user/tez下</p>
</li>
<li><p>修改hadoop-env.sh追加下面配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TEZ_CONF_DIR=xxx/tez-site.xml</span><br><span class="line">TEZ_JARS=xxx/apache-tez-0.9.0-bin</span><br><span class="line">export HADOOP_CLASSPATH=$&#123;HADOOP_CLASSPATH&#125;:$&#123;TEZ_CONF_DIR&#125;:$&#123;TEZ_JARS&#125;/*:$&#123;TEZ_JARS&#125;/lib/*</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启hadoop以及hive</p>
</li>
<li><p>hive里写set hive.execution.engine=tez; (可以直接配在hive-site.xml里，如果想恢复可以写set hive.execution.engine=mr;)</p>
</li>
</ol>
<p><strong>如何开启Hive CLI的debug模式？</strong></p>
<p>hive –hiveconf hive.root.logger=INFO,console 启动hive，这样可以直接在cli里看到log内容</p>

        
        <div id="comment-container">
        </div>
    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        
        <li>
            <a target="_blank" href="http://weibo.com/5177514260">
                            <span class="fa-stack fa-lg">
                                  <i class="iconfont icon-weibo"></i>
                            </span>
            </a>
        </li>
        

        

        
        <li>
            <a target="_blank"  href="https://github.com/cherishher">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="HH的博客">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        看Husky的一点整理 - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> keep hungry, then you&#39;ll be really hungry </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>Max Qi</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#配置"><span class="toc-text">配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#组件"><span class="toc-text">组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Object-List"><span class="toc-text">Object List</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Channel"><span class="toc-text">Channel</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> keep hungry, then you&#39;ll be really hungry </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        看Husky的一点整理
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2018-08-08 10:34:42</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#CUHK" title="CUHK">CUHK</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <p>husky是一个通用的分布式的计算平台，就像mapreduce、spark这种，它是用c++写的（难受…）</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> Required</span><br><span class="line">master_host=master#master跑的地方</span><br><span class="line">master_port=10086#master绑定的端口</span><br><span class="line">comm_port=12306#worker绑定的端口</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Worker information</span><br><span class="line">[worker]</span><br><span class="line">info=worker1:4#worker1有4个线程</span><br><span class="line">info=worker2:4#worker2有4个线程</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>如果用了hdfs，配置hdfs路径</span><br><span class="line">hdfs_namenode=master</span><br><span class="line">hdfs_namenode_port=9000</span><br></pre></td></tr></table></figure>
<p>运行的时候用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./program --conf=/path/to/config.ini</span><br></pre></td></tr></table></figure>
<p>写入配置。</p>
<h2 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h2><h3 id="Object-List"><a href="#Object-List" class="headerlink" title="Object List"></a>Object List</h3><p>Object List（objList）是husky中最主要的对象，可以把任何对象都存在objlist中，两个objlist通过channel传递消息。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Obj</span> &#123;</span></span><br><span class="line">   <span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> KeyT = <span class="keyword">int</span>;</span><br><span class="line">    KeyT key;</span><br><span class="line">    <span class="function"><span class="keyword">const</span> KeyT&amp; <span class="title">id</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">    Obj() = <span class="keyword">default</span>;</span><br><span class="line">    explicit Obj(const KeyT&amp; k) : key(k) &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>创建一个obj只要3步：</p>
<ol>
<li>定义一个key的类型（keyT），一般都用int</li>
<li>写一个id（）函数来返回该对象对应的key</li>
<li>需要一个默认构造函数，还需要一个能够接收key参数的构造函数</li>
</ol>
<p>接下来就可以创建、使用、删除Object List</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建名叫my_objlist的objlist</span></span><br><span class="line"><span class="keyword">auto</span>&amp; objlist = ObjListStore::create_objlist&lt;Obj&gt;(<span class="string">"my_objlist"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//将obj传入创建好的objlist中</span></span><br><span class="line"><span class="function">Obj <span class="title">obj</span><span class="params">(<span class="number">3</span>)</span></span>;</span><br><span class="line">objlist.add_object(obj);</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过名字拿到对应的objlist，注意这里的auto关键字，自动判定类型，很舒服！</span></span><br><span class="line"><span class="keyword">auto</span>&amp; objlist2 = ObjListStore::get_objlist&lt;Obj&gt;(<span class="string">"my_objlist"</span>);  </span><br><span class="line"></span><br><span class="line"><span class="comment">//通过名字删除objlist</span></span><br><span class="line">ObjListStore::drop_objlist(<span class="string">"my_objlist"</span>);</span><br></pre></td></tr></table></figure>
<p>为了让添加在objlist中的obj被其他线程感知并利用，在多线程情况下需要将objlist全局化一下，husky已经封装好该方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">globalize(objlist);</span><br></pre></td></tr></table></figure>
<p>接下来就是<strong>最重要</strong>的一个函数list_execute（），它规定了list里的每个object需要做的事，这个函数是用户自己定义的。它有两个参数：</p>
<ul>
<li>第一个是要操作的objlist</li>
<li>第二个是这个objlist中每个obj要做的事，例如下面函数就是obj在log中打印id，包括之后用channel发送或接收消息也都是在这个函数里</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">list_execute(objlist, [](Obj&amp; obj) &#123;</span><br><span class="line">    base::log_msg(<span class="string">"My id is: "</span> + obj.id());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h3><p>channel就是object和object互相通信的工具，他们的关系类似于城市和公路。husky中有四种channel：</p>
<ul>
<li>Push Channel：最常见的点对点通信</li>
<li>Push Combined Channel：在push channel基础上增加了合并发给同个obj的</li>
<li>Broadcast Channel：将一个key-value广播出去，任何地方都可以通过key拿到值</li>
<li>Migrate Channel：用来migrate对象，将一个对象发送到另一个线程上</li>
</ul>
<p>channel的创建、使用和drop（一定要主动销毁）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create PushChannel</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> MsgT, <span class="keyword">typename</span> DstObjT&gt; </span><br><span class="line"><span class="keyword">static</span> PushChannel&lt;MsgT, DstObjT&gt;&amp; </span><br><span class="line">create_push_channel(ChannelSource&amp; src_list,</span><br><span class="line">                    ObjList&lt;DstObjT&gt;&amp; dst_list,</span><br><span class="line">                    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name = <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get PushChannel through name</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> MsgT, <span class="keyword">typename</span> DstObjT&gt;</span><br><span class="line"><span class="keyword">static</span> PushChannel&lt;MsgT, DstObjT&gt;&amp; </span><br><span class="line">get_push_channel(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name = <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Drop channel through name</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">drop_channel</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name)</span></span>;</span><br></pre></td></tr></table></figure>
<p>下面通过例子来说明：</p>
<p>首先，要想创建channel，就要确定发消息的源objlist和目的objlist，当然，参数里的目的objlist必须是全局化的</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建一个push_channel</span></span><br><span class="line"><span class="keyword">auto</span>&amp; ch = ChannelStore::create_push_channel&lt;<span class="keyword">int</span>&gt;(src_list, dst_list);</span><br></pre></td></tr></table></figure>
<p>一般来说，channel是放在list_execute（）函数里用的，要想清楚从哪个obj发，发什么，哪个obj接收（通过key来标注）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//push channel</span></span><br><span class="line"><span class="comment">//发送端代码</span></span><br><span class="line">list_execute(src_list, [&amp;ch](Obj&amp; obj) &#123;</span><br><span class="line">    ch.push(msg, key);  <span class="comment">// send msg to key</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//接收端代码</span></span><br><span class="line">list_execute(dst_list, [&amp;ch](Obj&amp; obj) &#123;</span><br><span class="line">    <span class="keyword">auto</span>&amp; msgs = ch.get(obj); <span class="comment">// The msgs is of type std::vector&lt;MsgT&gt;, MsgT is int in this case</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//broadcast channel</span></span><br><span class="line"><span class="keyword">auto</span>&amp; ch4 = ChannelStore::create_broadcast_channel&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt;(src_list);</span><br><span class="line">list_execute(src_list, [&amp;ch4](Obj&amp; obj) &#123;</span><br><span class="line">    ch4.broadcast(key, value);  <span class="comment">// broadcast key, value pair</span></span><br><span class="line">&#125;);</span><br><span class="line">list_execute(src_list, [&amp;ch4](Obj&amp; obj) &#123;</span><br><span class="line">    <span class="keyword">auto</span> msg = ch4.get(key);   <span class="comment">// get the broadcasted value through key.</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>###Aggregator</p>
<p>用来执行一些聚合操作的类，可以用来做求前k大值，统计数量，计算机器学习梯度总数等。他的构造函数需要两个参数（或以上），一个是init值，另外是lambda函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Aggregator&lt;<span class="keyword">int</span>&gt; agg(<span class="number">0</span>, [](<span class="keyword">int</span>&amp; a, <span class="keyword">const</span> <span class="keyword">int</span>&amp; b)&#123; a += b; &#125;);</span><br></pre></td></tr></table></figure>
<p>这个lambda函数就是aggregate的规则。</p>
<p>在创建完agregator后，就要使用它了。可以用update函数或者update_any函数（比update可接受参数类型多）来进行aggregator，例如</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">agg.update(<span class="number">1</span>);<span class="comment">//aggregator值加1</span></span><br></pre></td></tr></table></figure>
<p>在聚合完之后，更新的值其实只在本地，为了让这个值在全局响应要用HuskyAggregatorFactory::sync()函数。另一种方式是通过HuskyAggregatorFactory::get_channel()来拿到通道，然后在list_execute中通过这个channel把消息传播出去，这种方法最后也会去调用sync()函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//两种方式</span></span><br><span class="line">AggregatorFactory::sync();</span><br><span class="line"></span><br><span class="line"><span class="comment">// or using aggregator channel</span></span><br><span class="line"><span class="keyword">auto</span>&amp; ac = AggregatorFactory::get_channel();</span><br><span class="line">list_execute(obj_list, &#123;&#125;, &#123;&amp;ac&#125;, [&amp;](OBJ&amp; obj) &#123; </span><br><span class="line">  ...  <span class="comment">// here we can give updates to some aggregators</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当全局划这个聚合之后，就可以用get_value()函数得到值了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> sum = agg.get_value()</span><br></pre></td></tr></table></figure>
<p>这个值是被全局共享的，所以对他的修改会影响其他executor，并可能有线程安全问题</p>

        
        <div id="comment-container">
        </div>
    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        
        <li>
            <a target="_blank" href="http://weibo.com/5177514260">
                            <span class="fa-stack fa-lg">
                                  <i class="iconfont icon-weibo"></i>
                            </span>
            </a>
        </li>
        

        

        
        <li>
            <a target="_blank"  href="https://github.com/cherishher">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

</html>
